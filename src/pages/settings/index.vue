<script setup lang="ts">
definePage({
  name: 'settings',
  layout: 'tabbar',
  style: {
    navigationBarTitleText: '我的',
  },
})

const router = useRouter()
const userStore = useUserStore()
const authStore = useAuthStore()

const {
  theme,
  toggleTheme,
  currentThemeColor,
  showThemeColorSheet,
  themeColorOptions,
  openThemeColorPicker,
  closeThemeColorPicker,
  selectThemeColor,
} = useManualTheme()

const isDark = computed({
  get() {
    return theme.value === 'dark'
  },
  set() {
    toggleTheme()
  },
})

const userInfo = computed(() => userStore.userInfo || {})
const loginInfo = computed(() => userStore.loginInfo || {})

const displayName = computed(() => {
  const user = userInfo.value
  const login = loginInfo.value
  return (
    user.real_name
    || user.realName
    || user.user_name
    || user.userName
    || login.real_name
    || login.realName
    || login.user_name
    || login.userName
    || login.nick_name
    || login.nickName
    || login.account
    || user.account
    || '-'
  )
})

const employeeNumber = computed(() => {
  const user = userInfo.value
  const login = loginInfo.value
  return (
    user.account
    || user.userCode
    || user.jobNo
    || user.userId
    || user.user_id
    || login.account
    || login.userCode
    || login.jobNo
    || login.userId
    || login.user_id
    || '-'
  )
})

// 处理主题色选择
function handleThemeColorSelect(option: any) {
  selectThemeColor(option)
}

function handleLogout() {
  uni.showModal({
    title: '退出登录',
    content: '确认要退出登录吗？',
    success: (res) => {
      if (res.confirm) {
        authStore.logout()
        router.replaceAll({ name: 'login' })
      }
    },
  })
}
</script>

<template>
  <view class="box-border py-3">
    <demo-block title="我的" transparent>
      <wd-cell-group border custom-class="rounded-2! overflow-hidden">
        <wd-cell title="姓名" :value="displayName" />
        <wd-cell title="工号" :value="employeeNumber" />
      </wd-cell-group>
    </demo-block>

    <demo-block title="主题设置" transparent>
      <wd-cell-group border custom-class="rounded-2! overflow-hidden">
        <wd-cell title="暗黑模式">
          <wd-switch v-model="isDark" size="18px" />
        </wd-cell>
        <wd-cell title="选择主题色" is-link @click="openThemeColorPicker">
          <view class="flex items-center justify-end gap-2">
            <view
              class="h-4 w-4 rounded-full"
              :style="{ backgroundColor: currentThemeColor.primary }"
            />
            <text>{{ currentThemeColor.name }}</text>
          </view>
        </wd-cell>
      </wd-cell-group>
    </demo-block>

    <demo-block title="退出登录" transparent>
      <wd-cell-group border custom-class="rounded-2! overflow-hidden">
        <wd-cell title="退出登录" is-link @click="handleLogout" />
      </wd-cell-group>
    </demo-block>

    <!-- 主题色选择 ActionSheet -->
    <wd-action-sheet
      v-model="showThemeColorSheet"
      title="选择主题色"
      :close-on-click-action="true"
      @cancel="closeThemeColorPicker"
    >
      <view class="px-4 pb-4">
        <view
          v-for="option in themeColorOptions"
          :key="option.value"
          class="flex items-center justify-between border-b border-gray-100 py-3 last:border-b-0 dark:border-gray-700"
          @click="handleThemeColorSelect(option)"
        >
          <view class="flex items-center gap-3">
            <view
              class="h-6 w-6 border-2 border-gray-200 rounded-full dark:border-gray-600"
              :style="{ backgroundColor: option.primary }"
            />
            <text class="text-4 text-gray-800 dark:text-gray-200">
              {{ option.name }}
            </text>
          </view>
          <wd-icon
            v-if="currentThemeColor.value === option.value"
            name="check"
            :color="option.primary"
            size="20px"
          />
        </view>
      </view>
      <wd-gap :height="50" />
    </wd-action-sheet>
  </view>
</template>
